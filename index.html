<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecture Plaques</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    video { width: 100%; max-height: 40vh; margin-bottom: 10px; border: 1px solid #ccc; position: relative; }
    textarea { width: 100%; height: 150px; margin-top: 10px; font-family: monospace; }
    button { padding: 10px 15px; font-size: 16px; margin: 5px; cursor: pointer; }

    /* Cadre plaque */
    #overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 70%;
      height: 20%;
      transform: translate(-50%, -50%);
      border: 3px solid red;
      border-radius: 8px;
      pointer-events: none;
      box-sizing: border-box;
    }

    .video-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
  </style>
</head>
<body>

  <h2>Scanner une plaque</h2>
  <div class="video-container">
    <video id="video" autoplay playsinline></video>
    <div id="overlay"></div>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <br>
  <button id="captureBtn">üì∏ Prendre photo</button>
  <button id="clearBtn">üóëÔ∏è Effacer</button>

  <h3>D√©roulement de la mission</h3>
  <textarea id="missionLog" placeholder="Les plaques reconnues s'afficheront ici..."></textarea>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const log = document.getElementById("missionLog");
    const captureBtn = document.getElementById("captureBtn");
    const clearBtn = document.getElementById("clearBtn");
    const overlay = document.getElementById("overlay");

    // Charger l'historique au d√©marrage
    window.addEventListener("load", () => {
      const saved = localStorage.getItem("plaquesLog");
      if (saved) {
        log.value = saved;
      }
    });

    // Activer la cam√©ra arri√®re
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => alert("Erreur cam√©ra: " + err));

    // Obtenir uniquement l'heure (HH:MM:SS)
    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString("fr-FR", { hour12: false });
    }

    // Sauvegarder la zone dans localStorage
    function saveLog() {
      localStorage.setItem("plaquesLog", log.value);
    }

    // OCR optimis√© en noir et blanc
    function preprocessCanvas(ctx, width, height) {
      const imgData = ctx.getImageData(0, 0, width, height);
      for (let i = 0; i < imgData.data.length; i += 4) {
        const avg = (imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3;
        const val = avg > 128 ? 255 : 0;
        imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = val;
      }
      ctx.putImageData(imgData, 0, 0);
    }

    // Quand on clique sur "Prendre photo"
    captureBtn.addEventListener("click", async () => {
      // Taille de la vid√©o
      const vw = video.videoWidth;
      const vh = video.videoHeight;

      // Dimensions du cadre (en pourcentage)
      const ow = 0.7 * vw;   // 70% largeur
      const oh = 0.2 * vh;   // 20% hauteur
      const ox = (vw - ow) / 2;
      const oy = (vh - oh) / 2;

      // Canvas uniquement sur la zone du cadre
      canvas.width = ow;
      canvas.height = oh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, ox, oy, ow, oh, 0, 0, ow, oh);

      preprocessCanvas(ctx, canvas.width, canvas.height);

      try {
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng+fra');
        const cleaned = text.replace(/\s+/g, "").toUpperCase();

        // Regex plaques fran√ßaises
        const regexNouveau = /[A-Z]{2}\d{3}[A-Z]{2}/;          // Ex: AB123CD
        const regexAncien  = /\d{1,4}[ ]?[A-Z]{2,3}[ ]?\d{2}/; // Ex: 123AAA06 ou 123 AAA 06
        let match = regexNouveau.exec(cleaned) || regexAncien.exec(cleaned);

        if (match) {
          const plaque = match[0].replace(/\s+/g, ""); // supprime espaces internes
          const heure = getCurrentTime();

          log.value += `[${heure}] ‚Üí ${plaque}\n`;
          saveLog();
        } else {
          alert("‚ùå Aucune plaque d√©tect√©e, r√©essaie.");
        }
      } catch (e) {
        console.error("Erreur OCR:", e);
        alert("‚ö†Ô∏è Erreur de reconnaissance.");
      }
    });

    // Effacer zone + m√©moire
    clearBtn.addEventListener("click", () => {
      log.value = "";
      localStorage.removeItem("plaquesLog");
    });
  </script>
</body>
</html>