<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecture Plaques</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    video { width: 100%; max-height: 40vh; margin-bottom: 10px; border: 1px solid #ccc; }
    textarea { width: 100%; height: 150px; margin-top: 10px; font-family: monospace; }
    button { padding: 10px 15px; font-size: 16px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>Scanner une plaque</h2>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <br>
  <button id="captureBtn">üì∏ Prendre photo</button>
  <button id="clearBtn">üóëÔ∏è Effacer</button>

  <h3>D√©roulement de la mission</h3>
  <textarea id="missionLog" placeholder="Les plaques reconnues s'afficheront ici..."></textarea>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const log = document.getElementById("missionLog");
    const captureBtn = document.getElementById("captureBtn");
    const clearBtn = document.getElementById("clearBtn");

    // Charger l'historique au d√©marrage
    window.addEventListener("load", () => {
      const saved = localStorage.getItem("plaquesLog");
      if (saved) {
        log.value = saved;
      }
    });

    // Activer la cam√©ra arri√®re
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => alert("Erreur cam√©ra: " + err));

    // Obtenir uniquement l'heure (HH:MM:SS)
    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString("fr-FR", { hour12: false });
    }

    // Sauvegarder la zone dans localStorage
    function saveLog() {
      localStorage.setItem("plaquesLog", log.value);
    }

    // Quand on clique sur "Prendre photo"
    captureBtn.addEventListener("click", async () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      try {
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
        const cleaned = text.replace(/\s+/g, "").toUpperCase();

        // Regex simple pour plaque (adapter au pays si besoin)
        const plateRegex = /[A-Z0-9]{4,9}/;
        const match = plateRegex.exec(cleaned);

        if (match) {
          const plaque = match[0];
          const heure = getCurrentTime();

          // Ajouter dans la zone mission
          log.value += `${heure} - ${plaque}\n`;
          saveLog();
        } else {
          alert("‚ùå Aucune plaque d√©tect√©e, r√©essaie.");
        }
      } catch (e) {
        console.error("Erreur OCR:", e);
        alert("‚ö†Ô∏è Erreur de reconnaissance.");
      }
    });

    // Effacer zone + m√©moire
    clearBtn.addEventListener("click", () => {
      log.value = "";
      localStorage.removeItem("plaquesLog");
    });
  </script>
</body>
</html>